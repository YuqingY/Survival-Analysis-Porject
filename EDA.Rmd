---
title: "EDA"
author: "Helen Lan & Rachel Yang"
date: "4/7/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(broom)
#library(tidylog)
library(ggfortify)
library(survival)
library(reshape2)
library(ggplot2)
```

```{r, include=FALSE}
AIDS <- read_csv("~/Desktop/Math150-Project/AIDSdata.csv")
```
```{r}
summary(AIDS$age)
summary(AIDS$time_d)
AIDS$SurvObj <- with( AIDS, Surv(time_d, censor == 0))
km.AIDS <- survfit(SurvObj ~ 1, data = AIDS, conf.type = "log-log")
autoplot(km.AIDS)
```

Something New No.2: Deriving/detailing AIC&BIC for model seleciton on Cox PH (Helen)
###AIC Method
```{r, warning=FALSE}
#Forward Selection using AIC 
aids.aic <- coxph(Surv(time,censor == 1) ~ 1,data = AIDS)
step(aids.aic, ~tx + txgrp + strat2 + sex + raceth + ivdrug + hemophil + karnof + cd4 + age + priorzdv, data = AIDS, direction = "forward", k=2)
```

At this step, forward selection using AIC suggests that the model without any additional variable will have the smallest AIC. So our result from forward selection using AIC indicates that we should include tx + ivdrug + karnof + cd4 + age in our model. 

```{r, warning=FALSE}
#Backward Selection using AIC 
aids.aic <- coxph(Surv(time,censor == 1) ~ tx + txgrp + strat2 + sex + raceth + ivdrug + hemophil + karnof + cd4 + age + priorzdv,data = AIDS)
step(aids.aic, ~tx + txgrp + strat2 + sex + raceth + ivdrug + hemophil + karnof + cd4 + age + priorzdv, data = AIDS, direction = "backward", k=2)
```
The result from backward selection using AIC indicates that we should include tx + ivdrug + karnof + cd4 + age in our model. 

```{r}
#Final model suggested by AIC:
aids.aic1 <- coxph(Surv(time,censor == 1) ~ tx + ivdrug + karnof + cd4 + age,data = AIDS)
aids.aic1 %>% tidy()
aids.aic1 %>% glance()
```
###BIC Method
```{r, warning=FALSE}
#Forward Selection using BIC
dim(AIDS)
aids.bic <- coxph(Surv(time,censor == 1) ~ 1,data = AIDS)
step(aids.bic, ~tx + txgrp + strat2 + sex + raceth + ivdrug + hemophil + karnof + cd4 + age + priorzdv, data = AIDS, direction = "forward", k=log(135))
```
The result from forward selection using BIC indicates that we should include tx  + karnof + cd4 in our model.

```{r, warning=FALSE}
#Backward Selection using BIC
aids.bic <- coxph(Surv(time,censor == 1) ~ tx + txgrp + strat2 + sex + raceth + ivdrug + hemophil + karnof + cd4 + age + priorzdv,data = AIDS)
step(aids.bic, ~tx + txgrp + strat2 + sex + raceth + ivdrug + hemophil + karnof + cd4 + age + priorzdv, data = AIDS, direction = "backward", k=log(135))
```
The result from backward selection using BIC indicates that we should include tx  + karnof + cd4 in our model.

```{r}
#Final model suggested by BIC:
aids.bic1 <- coxph(Surv(time,censor == 1) ~ tx + karnof + cd4,data = AIDS)
aids.bic1 %>% tidy()
aids.bic1 %>% glance()
```
Something New
1. Investigation of PH assumption (Rachel)
1.1 Introduction 
1.1.1 What is PH Assumption, and why it is important?
    Proportional Harzard(PH) Assumption is the assumption that any two groups 
    in the study must have hazard functions that are proportional over time 
    (i.e. have parallel curve). A non-proportional hazard means that there is 
    an interation between our independent variable and time, therefore we need 
    to do more work and be more careful when designing our model.
1.1.2 Resources
    My knowledge of the concept of PH Assumption mainly comes from 
    class lectures. I will use r documentation(linked below) to learn about the 
    cox.zph function.
    https://www.rdocumentation.org/packages/survival/versions/2.43-3/topics/cox.zph
1.1.3 Challenges
    The first challenge is figuring out the r code. The second challenge is 
    interpretating of the result and deciding what to do with our model base on 
    the result.
1.2 Testing the PH Assumption
```{r}
cox.zph(coxph(Surv(time,censor == 1) ~ tx + ivdrug + karnof + cd4 + age, data = AIDS))
ggsurvplot(survfit(Surv(time,censor == 1) ~ cd4grp, data = AIDS), fun = "cloglog")
ggsurvplot(survfit(Surv(time,censor == 1) ~ karnof, data = AIDS), fun = "cloglog")
ggsurvplot(survfit(Surv(time,censor == 1) ~ tx, data = AIDS), fun = "cloglog")
ggsurvplot(survfit(Surv(time,censor == 1) ~ agegrp, data = AIDS), fun = "cloglog")
ggsurvplot(survfit(Surv(time,censor == 1) ~ ivdrug, data = AIDS), fun = "cloglog")
```
1.3 Interpretation
1.4 Actions

2. Deriving/detailing AIC&BIC for model seleciton on Cox PH (Helen)

2.1 Introduction (An overview of Christensen, 2018)
  Akaike (1974) introduced the first information criterion, the Akaike Information
Criterion (AIC). AIC was based on Kullback-Leibler (K-L) distance (Kullback & Leibler, 1951), which connected information is a way of conceptualizing the distance, or discrepancy, between two models: f(x), the “true” or “generating” model from which actual observations emerge, and g(x), a model given by the researcher to predict the population. K-L distance can be understood as the information lost
when g(x) is used to approximate f(x). If g(x) is exactly the same as f(x), then the K-L distance between the two models is zero.In practice, the “true” model is unknown, so the absolute K-L distance between f(x) and g(x) is impossible to compute. Yet relative distances can be computed when we are evaluating two or more prediction models. Akaike’s (1974) key insight was that maximum likelihood estimation, with some correction based on the number of parameters in the model, is the expected K-L distance.

2.1.1 Definition and derivation of AIC & BIC
    AIC: Akaike’s Information Criteria =  −2ln likelihood + 2p
    BIC: Bayesian Information Criteria =  −2ln likelihood + pln(n)
    where p is the number of estimated parameters (the number of explanatory variables plus 1) and n is the sample size. Likelihood is evaluated at Maximum Likelihood Estimator. AIC and BIC measure the model's generalizability.Both techniques suggest choosing a model with the smallest AIC or BIC value. Information criteria in general measures the information lost when we use a statistical model to approximate the true model. Thus, the less information is lost during this process, the better the approximating model is. 
    
2.1.2 Resources
    I came to know this concept from our lecture's brief introduction to AIC and BIC when we talked about model building.
    I learned more about information criteria in model selection through Christensen(UCLA)'s publication
    https://www.sas.com/content/dam/SAS/support/en/sas-global-forum-proceedings/2018/2587-2018.pdf
    R codes and BeSS Package: https://cran.r-project.org/web/packages/BeSS/BeSS.pdf
2.1.3 Challenges
    It is challenging to understand the application of AIC/BIC in Cox PH model selection and get the R codes to work. 
2.2 Deriving AIC & BIC on Cox PH in R
2.3 Forward selection using AIC & BIC
2.4 Backward selection using AIC & BIC
2.5 Interpretation and conclusion
