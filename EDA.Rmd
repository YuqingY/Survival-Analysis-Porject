---
title: "EDA"
author: "Helen Lan & Rachel Yang"
date: "4/7/2019"
output: html_document
---

```{r global_options, include=TRUE, message=FALSE, warning=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(broom)
#library(tidylog)
library(ggfortify)
library(survival)
library(reshape2)
library(ggplot2)
library(survminer)
```
##EDA
```{r, include=FALSE}
AIDS <- read_csv("https://raw.githubusercontent.com/YuqingY/Survival-Analysis-Project/master/AIDSdata.csv")
AIDS$cd4grp <- floor(AIDS$cd4/50)
AIDS$agegrp <- floor(AIDS$age/10)
AIDS$ivgrp <- floor(AIDS$ivdrug/2)
```
```{r}
summary(AIDS$age)
summary(AIDS$time_d)
AIDS$SurvObj <- with( AIDS, Surv(time_d, censor == 0))
km.AIDS <- survfit(SurvObj ~ 1, data = AIDS, conf.type = "log-log")
autoplot(km.AIDS)
```
##Introduction
  According to a New York Time article "Tough Question to Answer, Tough Answer to Hear," prognosticating is one of the most challenging tasks doctors face. However, despite the challenging and imperfect nature of prognosis, it is very important for a patient to know how much time he/she has left, given that there is often much to plan for and accomplish before a progressive illness robs patients of their physical or mental abilities. For patients carrying human immunodeficiency virus type 1 (HIV 1), it is important for them to know how much time do they have left until the development of the acquired immunodeficiency syndrome (AIDS) or death, and more importantly, how to prolong their life before death. 
  To answer this question, we use the data from a double-blind, placebo-controlled trial that compared the three-drug regimen of indinavir (IDV), open-label zidovudine (ZDV) or stavudine (d4T) and lamivudine (3TC) with the two-drug regimen of zidovudine or stavudine and lamivudine in HIV-infected patients (Hammer et al., 1997). Besides having the treatment method, this dataset also has a lot of other information about the patients, including their age, sex, race, IV drug use history, hemophiliac, Karnofsky performance scale, as well as baseline CD4 count. Using the data, we want to know what variables contribute to a longer time to event (development of AIDS or death) and use those variables to create a model that predicts the time to the development of the AIDS or death for HIV-1 patients.
  We choose to use a Cox proportional hazard model to predict the time to event. We use the AIC method for model selection and assume proportional hazard, which is also tested in the report.

##Methods
  We use a dataset that has 851 patients information, and use AIC model building technique to select the variables that best predict the time to event (development of AIDS or death) from a groups of 11 variables, including age, sex, race, IV drug history, hemophiliac, Karnofsky performance score, baseline CD4 level, as well as months of prior ZDV use. We also looked at possible interaction of variables but decided against interaction base on large p-values. Using the variables selected, we test the Proportional Hazard assumption and build a Cox Proportional Hazard Model that we believe best predict the time to event. The primary endpoint was the time to the development of the acquired immunodeficiency syndrome (AIDS) or death.
  
##Result

###1. Deriving/detailing AIC&BIC for model seleciton on Cox PH (Helen)

###2.1 Introduction (An overview of Christensen, 2018)
  Akaike (1974) introduced the first information criterion, the Akaike Information
Criterion (AIC). AIC was based on Kullback-Leibler (K-L) distance (Kullback & Leibler, 1951), which connected information is a way of conceptualizing the distance, or discrepancy, between two models: f(x), the “true” or “generating” model from which actual observations emerge, and g(x), a model given by the researcher to predict the population. K-L distance can be understood as the information lost
when g(x) is used to approximate f(x). If g(x) is exactly the same as f(x), then the K-L distance between the two models is zero.In practice, the “true” model is unknown, so the absolute K-L distance between f(x) and g(x) is impossible to compute. Yet relative distances can be computed when we are evaluating two or more prediction models. Akaike’s (1974) key insight was that maximum likelihood estimation, with some correction based on the number of parameters in the model, is the expected K-L distance.

###1.1.1 Definition and derivation of AIC & BIC
    AIC: Akaike’s Information Criteria =  −2ln likelihood + 2p
    BIC: Bayesian Information Criteria =  −2ln likelihood + pln(n)
    where p is the number of estimated parameters (the number of explanatory variables plus 1) and n is the sample size. Likelihood is evaluated at Maximum Likelihood Estimator. AIC and BIC measure the model's generalizability.Both techniques suggest choosing a model with the smallest AIC or BIC value. Information criteria in general measures the information lost when we use a statistical model to approximate the true model. Thus, the less information is lost during this process, the better the approximating model is. 
    The derivation of AIC and BIC is based on maximum likelihood estimation. With some correction based on the number of parameters in the model to MLE will be the expected K-L distance. We want the likelihood to be maximized because that says that the model describes our data well. We therefore subtract 2 times the ln likelihood to the expected K-L distance because higher likelihood means that our model fits the data better, and thus the information lost is less. To avoid overfitting the model, Akaike added 2 times the number of estimated parameters back to the K-L distance to account for the number of parameters in the model. The addition of 2p will increase the K-L distance, and thus works as a punishment of extra parameters estimated to avoid overfitting. BIC suggests that the adjustment made is p*ln(n) to both account for the effect of number of parameters estimated and the sample size. 
    
    
###1.1.2 Resources
    I came to know this concept from our lecture's brief introduction to AIC and BIC when we talked about model building.
    I learned more about information criteria in model selection through Christensen(UCLA)'s publication
    https://www.sas.com/content/dam/SAS/support/en/sas-global-forum-proceedings/2018/2587-2018.pdf
    R codes and BeSS Package: https://cran.r-project.org/web/packages/BeSS/BeSS.pdf
###1.1.3 Challenges
    It is challenging to understand the application of AIC/BIC in Cox PH model selection and get the R codes to work.
###1.2 Model selection using AIC
```{r, warning=FALSE}
#Forward Selection using AIC 
aids.aic <- coxph(Surv(time,censor == 1) ~ 1,data = AIDS)
step(aids.aic, ~tx + txgrp + strat2 + sex + raceth + ivdrug + hemophil + karnof + cd4 + age + priorzdv, data = AIDS, direction = "forward", k=2)
```

At this step, forward selection using AIC suggests that the model without any additional variable will have the smallest AIC. So our result from forward selection using AIC indicates that we should include tx + ivdrug + karnof + cd4 + age in our model. 

```{r, warning=FALSE}
#Backward Selection using AIC 
aids.aic <- coxph(Surv(time,censor == 1) ~ tx + txgrp + strat2 + sex + raceth + ivdrug + hemophil + karnof + cd4 + age + priorzdv,data = AIDS)
step(aids.aic, ~tx + txgrp + strat2 + sex + raceth + ivdrug + hemophil + karnof + cd4 + age + priorzdv, data = AIDS, direction = "backward", k=2)
```
The result from backward selection using AIC indicates that we should include tx + ivdrug + karnof + cd4 + age in our model. 

```{r}
#Final model suggested by AIC:
aids.aic1 <- coxph(Surv(time,censor == 1) ~ tx + ivdrug + karnof + cd4 + age,data = AIDS)
aids.aic1 %>% tidy()
aids.aic1 %>% glance()
```
###1.3 Model selection using BIC
```{r, warning=FALSE}
#Forward Selection using BIC
dim(AIDS)
aids.bic <- coxph(Surv(time,censor == 1) ~ 1,data = AIDS)
step(aids.bic, ~tx + txgrp + strat2 + sex + raceth + ivdrug + hemophil + karnof + cd4 + age + priorzdv, data = AIDS, direction = "forward", k=log(135))
```
The result from forward selection using BIC indicates that we should include tx  + karnof + cd4 in our model.

```{r, warning=FALSE}
#Backward Selection using BIC
aids.bic <- coxph(Surv(time,censor == 1) ~ tx + txgrp + strat2 + sex + raceth + ivdrug + hemophil + karnof + cd4 + age + priorzdv,data = AIDS)
step(aids.bic, ~tx + txgrp + strat2 + sex + raceth + ivdrug + hemophil + karnof + cd4 + age + priorzdv, data = AIDS, direction = "backward", k=log(135))
```
The result from backward selection using BIC indicates that we should include tx  + karnof + cd4 in our model.

```{r}
#Final model suggested by BIC:
aids.bic1 <- coxph(Surv(time,censor == 1) ~ tx + karnof + cd4,data = AIDS)
aids.bic1 %>% tidy()
aids.bic1 %>% glance()
```

###1.4 Interpretation 
Given the results of AIC and BIC model selection methods, we decide to further work on the final model suggested by AIC selection, which includes the variables "tx", "ivdrug", "karnof", "cd4", and "age". This is because BIC suggested a model with only three variables but we want to keep a reasonable number of variables in our preliminary model to have enough interaction to build a more refined model. 

###1.5 Model Selection with Interaction
Using the results from AIC model selection, we want to further build our model including terms of interaction through backwar selection. We decided the interaction terms based on their correlation and medical relevance. 

```{r}
aids11 <- coxph(Surv(time,censor == 1) ~ tx + ivdrug + karnof + cd4 + age + ivdrug*cd4 + ivdrug*karnof + karnof*cd4 + karnof*age + cd4*age,  data = AIDS)
drop1(aids11,data=AIDS,test="Chisq")
```

```{r}
#-'ivdrg*cd4'
aids11 <- coxph(Surv(time,censor == 1) ~ tx + ivdrug + karnof + cd4 + age + ivdrug*karnof + karnof*cd4 + karnof*age + cd4*age, data = AIDS)
drop1(aids11,data=AIDS,test="Chisq")
```

```{r}
#-'ivdrug*karnof'
aids11 <- coxph(Surv(time,censor == 1) ~ tx + ivdrug + karnof + cd4 + age + karnof*cd4 + karnof*age + cd4*age,  data = AIDS)
drop1(aids11,data=AIDS,test="Chisq")  

```
At this step, we see that ivdrug has the largest p-value and all interaction terms have smaller p-values than ivdrug. Since we want to keep our original variable ivdrug in the model, we do not want to subtract it from the model. We'll stop here for our interaction model:
```{r}
aids.interaction <- coxph(Surv(time,censor == 1) ~ tx + ivdrug + karnof + cd4 + age + karnof*cd4 + karnof*age + cd4*age,data = AIDS)
aids.interaction %>% tidy()
aids.interaction %>% glance()
```
###1.6 Conclusion
Since our interaction model gives large p-values on all interaction terms, and even larger p-values of our original variables than our AIC model, we decide to not include interaction in our model and procede with the AIC model, which is our final model built:

```{r}
#Final model selected in the model building process:
aids.aic1 <- coxph(Surv(time,censor == 1) ~ tx + ivdrug + karnof + cd4 + age,data = AIDS)
aids.aic1 %>% tidy()
aids.aic1 %>% glance()
```

###2. Investigation of PH assumption (Rachel)
####2.1 Introduction 
#####2.1.1 What is PH Assumption, and why it is important?
    Proportional Harzard(PH) Assumption is the assumption that any two groups in the study must have hazard functions that are proportional over time (i.e. have parallel curve). A non-proportional hazard means that there is an interation between our independent variable and time, therefore we need to do more work and be more careful when designing our model.
#####2.1.2 Resources
    My knowledge of the concept of PH Assumption mainly comes from class lectures. I will use r documentation(linked below) as well as the UCLA survival to learn about the cox.zph function.
    https://www.rdocumentation.org/packages/survival/versions/2.43-3/topics/cox.zph
#####2.1.3 Challenges
    The first challenge is figuring out the r code. The second challenge is interpretating of the result and deciding what to do with our model base on the result.          
####2.2 Testing the PH Assumption
    To test the Proportional Harzard (PH) assumption, I use the cox.zph function in r. The cox.zph function will test proportionality of all the predictors in the model by creating interactions with time using the transformation of time specified in the transform option.
```{r}
cox.zph(coxph(Surv(time,censor == 1) ~ tx + ivdrug + karnof + cd4 + age, data = AIDS))
```
    According to the result of the cox.zph test, none of the variables has a p value less than 0.05, hence we fail to reject the null hypothesis. We conclude that these variables are *not* time dependent variables, as demonstrated below. 
```{r}
ggsurvplot(survfit(Surv(time,censor == 1) ~ cd4grp, data = AIDS), fun = "cloglog")
ggsurvplot(survfit(Surv(time,censor == 1) ~ karnof, data = AIDS), fun = "cloglog")
ggsurvplot(survfit(Surv(time,censor == 1) ~ tx, data = AIDS), fun = "cloglog")
ggsurvplot(survfit(Surv(time,censor == 1) ~ agegrp, data = AIDS), fun = "cloglog")
ggsurvplot(survfit(Surv(time,censor == 1) ~ ivdrug, data = AIDS), fun = "cloglog")
```

####2.3 Interpretation
    Base on the cox.zph test as well as the graph, we conclude that we can assume proportional harzard and proceed to our model.
    
##Exploration
```{r}
#Backward Selection
aids.aic <- coxph(Surv(time,censor == 1) ~ tx + txgrp + strat2 + sex + raceth + ivdrug + hemophil + karnof + cd4 + age + priorzdv + ivgrp,data = AIDS)
step(aids.aic, ~tx + txgrp + strat2 + sex + raceth + ivdrug + hemophil + karnof + cd4 + age + priorzdv + ivgrp, data = AIDS, direction = "backward", k=2)
#Cox PH
coxph(formula = Surv(time, censor == 1) ~ tx + karnof + cd4 + age + ivgrp, data = AIDS)
```

